<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.togest.dao.CheckSystemDao">
	<resultMap id="BaseResultMap" type="com.togest.domain.CheckSystemDTO">
		<id column="id" property="id" />
		<result column="code" property="code" />
		<result column="custom_code" property="customCode" />
		<result column="name" property="name" />
		<result column="description" property="description" />
		<result column="icon" property="icon" />
		<result column="href" property="href" />
		<result column="is_use" property="isUse" />
		<result column="sort" property="sort" />
		<collection property="params" javaType="java.util.List"
			ofType="com.togest.domain.CheckParamDTO">
			<result column="p_id" property="id" />
			<result column="p_name" property="name" />
			<result column="p_code" property="code" />
			<result column="p_sort" property="sort" />
		</collection>
		<collection property="defectTypes" javaType="java.util.List"
			ofType="com.togest.domain.DefectTypeDTO">
			<id column="d_id" property="id" />
			<result column="d_code" property="code" />
			<result column="d_name" property="name" />
			<result column="d_descrption" property="descrption" />
			<result column="d_target_param_id" property="targetParamId" />
			<result column="d_parent_id" property="parentId" />
			<result column="d_sort" property="sort" />
		</collection>
	</resultMap>

	<sql id="Base_Column_List">
		a.id, a.code, a.custom_code, a.name, a.description, a.icon,
		a.href,
		a.is_use, a.sort,
		p.id as p_id,p.name as p_name,p.code as
		p_code,p.sort as p_sort,
		d.id as d_id,d.name as d_name,d.code as
		d_code,d.descrption as d_descrption,
		d.target_param_id as
		d_target_param_id,d.parent_id as d_parent_id,d.sort as d_sort
	</sql>
	<sql id="Base_Table_List">
		6c_system a
		left join 6c_system_param ap on ap.system_id=a.id
		left join 6c_param p on ap.param_id=p.id and p.del_flag=0
		left join 6c_system_defect_type ad on ad.system_id = a.id
		left join 6c_defect_type d on ad.defect_type_id = d.id and d.del_flag=0
	</sql>
	<select id="getByKey" resultMap="BaseResultMap" parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from
		<include refid="Base_Table_List" />
		where
		a.id = #{id} and a.del_flag=0
	</select>
	<select id="getByEntity" parameterType="com.togest.domain.CheckSystemDTO"
		resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from
		<include refid="Base_Table_List" />
		<where>
			<if test="code != null">
				and a.code = #{code}
			</if>
			<if test="customCode != null">
				and a.custom_code = #{customCode}
			</if>
			<if test="name != null">
				and a.name = #{name}
			</if>
			<if test="description != null">
				and a.description = #{description}
			</if>
			<if test="icon != null">
				and a.icon = #{icon}
			</if>
			<if test="href != null">
				and a.href = #{href}
			</if>
			<if test="isUse != null">
				and a.is_use = #{isUse}
			</if>
			<if test="sort != null">
				and a.sort = #{sort}
			</if>
			and a.del_flag=0
		</where>
	</select>
	<select id="getListByKeys" resultMap="BaseResultMap"
		parameterType="java.util.List">
		select
		<include refid="Base_Column_List" />
		from
		<include refid="Base_Table_List" />
		<where>
			a.id in
			<foreach collection="ids" item="item" index="index" open="("
				separator="," close=")">#{item}</foreach>
			and a.del_flag=0
		</where>
	</select>

	<select id="findAllList" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from
		<include refid="Base_Table_List" />

		where a.del_flag=0
		order by a.sort
	</select>

	<select id="findList" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from
		<include refid="Base_Table_List" />
		<where>
			<if test="code != null">
				and a.code = #{code}
			</if>
			<if test="customCode != null">
				and a.custom_code = #{customCode}
			</if>
			<if test="name != null">
				and a.name like '%${name}%'
			</if>
			<if test="description != null">
				and a.description = #{description}
			</if>
			<if test="icon != null">
				and a.icon = #{icon}
			</if>
			<if test="href != null">
				and a.href = #{href}
			</if>
			<if test="isUse != null">
				and a.is_use = #{isUse}
			</if>
			<if test="sort != null">
				and a.sort = #{sort}
			</if>
			and a.del_flag=0
		</where>
		order by a.sort
	</select>

	<insert id="insert" parameterType="com.togest.domain.CheckSystemDTO">
		insert into 6c_system
		(id, code, custom_code,
		name, description, icon,
		href, is_use, del_flag,
		create_ip,
		create_by,
		create_date
		<if test="sort!=null or sort==0">,sort</if>
		)
		values
		(#{id}, #{code}, #{customCode},
		#{name}, #{description}, #{icon},
		#{href}, #{isUse}, #{delFlag},
		#{createIp},
		#{createBy},
		current_timestamp
		<if test="sort!=null or sort==0">,#{sort}</if>
		)
	</insert>

	<update id="update" parameterType="com.togest.domain.CheckSystemDTO">
		update 6c_system
		set
		<if test="sort!=null or sort==0">sort=#{sort},</if>
		code = #{code},
		custom_code = #{customCode},
		name = #{name},
		description
		= #{description},
		icon = #{icon},
		href = #{href},
		is_use = #{isUse},
		update_ip = #{updateIp},
		update_by = #{updateBy},
		update_date =
		current_timestamp

		where
		id = #{id}
	</update>

	<update id="deleteFalse" parameterType="com.togest.domain.CheckParamDTO">
		update
		6c_system
		set
		del_flag=1,delete_ip=#{deleteIp},delete_by=#{deleteBy},delete_date=current_timestamp
		where
		id = #{id} and del_flag=0
	</update>

	<delete id="deleteByKey" parameterType="java.lang.String">
		delete from
		6c_system
		where id = #{id}
		and del_flag=0
	</delete>

	<update id="deleteFalses" parameterType="java.util.Map">
		update 6c_system set
		del_flag=1,delete_ip=#{deleteIp},delete_by=#{deleteBy},delete_date=current_timestamp
		where id in
		<foreach item="item" collection="ids" separator="," open="("
			close=")" index="">
			#{item}
		</foreach>
	</update>

	<insert id="insertSystemParam" parameterType="java.util.Map">
		INSERT INTO
		6c_system_param(
		system_id,
		param_id
		)
		<foreach collection="paramIds" item="paramId" separator=" union all ">
			SELECT
			#{systemId}, #{paramId}
		</foreach>
	</insert>

	<insert id="insertSystemDefectType" parameterType="java.util.Map">
		INSERT INTO
		6c_system_defect_type(
		system_id,
		defect_type_id
		)
		<foreach collection="defectTypeIds" item="defectTypeId"
			separator=" union all ">
			SELECT
			#{systemId}, #{defectTypeId}
		</foreach>
	</insert>

	<delete id="deleteSystemParam" parameterType="java.lang.String">
		delete from
		6c_system_param where system_id=#{systemId}
	</delete>

	<delete id="deleteSystemDefectType" parameterType="java.lang.String">
		delete from 6c_system_defect_type where system_id=#{systemId}
	</delete>
	
</mapper>